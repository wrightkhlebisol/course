<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Root Cause Analysis Engine - Day 83</title>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <link rel="icon" href="data:," />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0f1214;
            --secondary-bg: #1a1f23;
            --card-bg: #22272b;
            --accent-color: #00b3c4;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --border-color: #2d333b;
            --success-color: #3fb950;
            --warning-color: #d29922;
            --error-color: #f85149;
            --link-color: #58a6ff;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--primary-bg);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .header {
            background: var(--secondary-bg);
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card h2::before {
            content: "";
            width: 3px;
            height: 16px;
            background: var(--accent-color);
            margin-right: 0.75rem;
            border-radius: 2px;
        }

        .incident-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .incident-item {
            background: var(--secondary-bg);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--accent-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .incident-item:hover {
            background: color-mix(in srgb, var(--secondary-bg) 85%, white);
            transform: translateX(2px);
        }

        .incident-item.selected {
            background: color-mix(in srgb, var(--accent-color) 15%, var(--secondary-bg));
            border-left-color: var(--accent-color);
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .incident-id {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .incident-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .root-cause {
            font-size: 0.875rem;
            color: var(--error-color);
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .confidence {
            background: var(--success-color);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .timeline-container {
            height: 400px;
            overflow-y: auto;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 1rem;
            position: relative;
            padding-left: 1.5rem;
        }

        .timeline-item::before {
            content: "";
            position: absolute;
            left: 6px;
            top: 24px;
            bottom: -12px;
            width: 1px;
            background: var(--border-color);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 6px;
            border: 2px solid var(--card-bg);
        }

        .timeline-marker.error {
            background: var(--error-color);
        }

        .timeline-marker.warning {
            background: var(--warning-color);
        }

        .timeline-marker.info {
            background: var(--accent-color);
        }

        .timeline-content {
            flex: 1;
            background: var(--secondary-bg);
            padding: 0.75rem 1rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .timeline-service {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timeline-message {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .timeline-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .analysis-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s ease;
        }

        .btn:hover {
            background: #3182ce;
        }

        .btn.secondary {
            background: #718096;
        }

        .btn.secondary:hover {
            background: #4a5568;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-indicator.connected {
            background: #48bb78;
        }

        .status-indicator.disconnected {
            background: #e53e3e;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .graph-container {
            height: 500px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--secondary-bg);
            padding: 1.25rem;
            overflow: hidden;
        }

        .graph-container > div {
            width: 100% !important;
            height: 100% !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            border: 2px solid var(--primary-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: color-mix(in srgb, var(--border-color) 85%, white);
        }

        /* Firefox Scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--primary-bg);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            width: 100%;
            grid-column: 1 / -1;
        }

        .tab-content.active {
            display: block;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            width: 100%;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 300px;
        }

        .metric-chart {
            height: 250px;
            width: 100%;
        }



        /* Settings */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .setting-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 8px;
        }

        .setting-group h3 {
            margin-bottom: 1rem;
            color: #2d3748;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .setting-item label {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .setting-item input,
        .setting-item select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        /* Alerts */
        .alerts-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: white;
        }

        .alert-item.error {
            border-left: 4px solid #e53e3e;
        }

        .alert-item.warning {
            border-left: 4px solid #ed8936;
        }

        .alert-item.info {
            border-left: 4px solid #4299e1;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab-btn {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Root Cause Analysis Engine</h1>
        <p>Day 83: Advanced Analytics for Distributed Log Processing | 
           <span class="status-indicator" id="wsStatus"></span>
           <span id="wsStatusText">Connecting...</span>
        </p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('incidents')">üìä Incidents</button>
            <button class="tab-btn" onclick="switchTab('metrics')">üìà System Metrics</button>
            <button class="tab-btn" onclick="switchTab('alerts')">üö® Alerts</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div id="incidents-tab" class="tab-content active">
            <div class="card">
                <h2>Recent Incidents</h2>
                <div class="analysis-controls">
                    <button class="btn" onclick="analyzeNewIncident()">üî¨ Analyze New Incident</button>
                    <button class="btn secondary" onclick="refreshIncidents()">üîÑ Refresh</button>
                </div>
                <div class="incident-list" id="incidentList">
                    <div style="text-align: center; color: #718096; padding: 2rem;">
                        Loading incidents...
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Event Timeline</h2>
                <div class="timeline-container" id="timelineContainer">
                    <div style="text-align: center; color: #718096; padding: 2rem;">
                        Select an incident to view timeline
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h2>Causal Relationship Graph</h2>
                <div class="graph-container" id="causalGraph">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #718096;">
                        Select an incident to view causal relationships
                    </div>
                </div>
            </div>
        </div>

        <div id="metrics-tab" class="tab-content">
            <div class="card full-width">
                <h2>System Performance</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>CPU Usage</h3>
                        <div id="cpuChart" class="metric-chart"></div>
                    </div>
                    <div class="metric-card">
                        <h3>Memory Usage</h3>
                        <div id="memoryChart" class="metric-chart"></div>
                    </div>
                    <div class="metric-card">
                        <h3>Disk I/O</h3>
                        <div id="diskChart" class="metric-chart"></div>
                    </div>
                    <div class="metric-card">
                        <h3>Network Traffic</h3>
                        <div id="networkChart" class="metric-chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="alerts-tab" class="tab-content">
            <div class="card full-width">
                <h2>System Alerts</h2>
                <div class="alerts-list" id="alertsList">
                    <div style="text-align: center; color: #718096; padding: 2rem;">
                        Loading alerts...
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="card full-width">
                <h2>Settings</h2>
                <div class="settings-form">
                    <div class="setting-group">
                        <h3>Alert Thresholds</h3>
                        <div class="setting-item">
                            <label>CPU Warning Threshold (%)</label>
                            <input type="number" id="cpuWarningThreshold" value="70" min="0" max="100">
                        </div>
                        <div class="setting-item">
                            <label>Memory Warning Threshold (%)</label>
                            <input type="number" id="memoryWarningThreshold" value="75" min="0" max="100">
                        </div>
                        <div class="setting-item">
                            <label>Disk Warning Threshold (%)</label>
                            <input type="number" id="diskWarningThreshold" value="80" min="0" max="100">
                        </div>
                    </div>
                    <div class="setting-group">
                        <h3>Display Settings</h3>
                        <div class="setting-item">
                            <label>Theme</label>
                            <select id="themeSelect">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="system">System Default</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>Refresh Interval (seconds)</label>
                            <input type="number" id="refreshInterval" value="30" min="5" max="300">
                        </div>
                    </div>
                    <button class="btn" onclick="saveSettings()">üíæ Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Metrics Service Configuration
        const METRICS_CONFIG = {
            updateInterval: 30000, // 30 seconds
            chartOptions: {
                responsive: true,
                displayModeBar: false,
                margin: { t: 30, r: 20, l: 40, b: 30 }
            }
        };

        // API Configuration
        const API_CONFIG = {
            baseUrl: window.location.origin,
            endpoints: {
                metrics: '/api/metrics',
                alerts: '/api/alerts',
                incidents: '/api/incidents',
                analyze: '/api/analyze-incident',
                causalGraph: '/api/causal-graph',
                health: '/api/health'
            },
            ws: {
                url: `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`,
                reconnectInterval: 3000,
                maxRetries: 5
            }
        };

        class RootCauseAnalysisApp {
            constructor() {
                this.currentIncident = null;
                this.ws = null;
                this.incidents = [];
                this.wsRetryCount = 0;
                this.metricsCache = new Map();
                this.metricsInterval = null;
                this.initializeWebSocket();
                this.loadIncidents();
            }

            async initializeWebSocket() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    return; // Already connected
                }

                try {
                    this.ws = new WebSocket(API_CONFIG.ws.url);
                    
                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                        this.updateConnectionStatus(true);
                        this.wsRetryCount = 0; // Reset retry count on successful connection
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            if (message.type === 'incident_update') {
                                this.handleIncidentUpdate(message.data);
                            } else if (message.type === 'metrics_update') {
                                this.handleMetricsUpdate(message.data);
                            }
                        } catch (error) {
                            console.error('Error processing WebSocket message:', error);
                        }
                    };
                    
                    this.ws.onclose = (event) => {
                        console.log('WebSocket disconnected:', event.code, event.reason);
                        this.updateConnectionStatus(false);
                        
                        // Implement exponential backoff for reconnection
                        if (this.wsRetryCount < API_CONFIG.ws.maxRetries) {
                            const delay = Math.min(1000 * Math.pow(2, this.wsRetryCount), 10000);
                            this.wsRetryCount++;
                            console.log(`Attempting to reconnect in ${delay}ms (attempt ${this.wsRetryCount})`);
                            setTimeout(() => this.initializeWebSocket(), delay);
                        } else {
                            console.error('Max WebSocket reconnection attempts reached');
                            document.getElementById('wsStatusText').textContent = 'Connection Failed - Please Refresh';
                        }
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateConnectionStatus(false);
                    };

                    // Set up ping/pong to keep connection alive
                    this.startPingInterval();

                } catch (error) {
                    console.error('Error initializing WebSocket:', error);
                    this.updateConnectionStatus(false);
                }
            }

            startPingInterval() {
                // Clear any existing interval
                if (this.pingInterval) {
                    clearInterval(this.pingInterval);
                }
                
                // Send ping every 30 seconds
                this.pingInterval = setInterval(() => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000);
            }

            updateConnectionStatus(connected) {
                const statusIndicator = document.getElementById('wsStatus');
                const statusText = document.getElementById('wsStatusText');
                
                if (connected) {
                    statusIndicator.className = 'status-indicator connected';
                    statusText.textContent = 'Real-time Connected';
                } else {
                    statusIndicator.className = 'status-indicator disconnected';
                    statusText.textContent = 'Connection Lost';
                }
            }

            async loadIncidents() {
                try {
                    const response = await fetch('/api/incidents');
                    const incidents = await response.json();
                    this.incidents = incidents;
                    this.renderIncidents();
                } catch (error) {
                    console.error('Failed to load incidents:', error);
                    document.getElementById('incidentList').innerHTML = 
                        '<div style="text-align: center; color: #e53e3e; padding: 2rem;">Failed to load incidents</div>';
                }
            }

            renderIncidents() {
                const container = document.getElementById('incidentList');
                
                if (this.incidents.length === 0) {
                    container.innerHTML = 
                        '<div style="text-align: center; color: #718096; padding: 2rem;">No incidents found</div>';
                    return;
                }

                const html = this.incidents.map(incident => {
                    const topRootCause = incident.root_causes && incident.root_causes.length > 0 
                        ? incident.root_causes[0] : null;
                    
                    const confidence = topRootCause 
                        ? Math.round(topRootCause.confidence * 100) : 0;
                    
                    const timestamp = new Date(incident.timestamp).toLocaleString();
                    
                    return `
                        <div class="incident-item" data-id="${incident.incident_id}" onclick="app.selectIncident('${incident.incident_id}', event)">
                            <div class="incident-header">
                                <span class="incident-id">Incident ${incident.incident_id}</span>
                                <span class="confidence">${confidence}%</span>
                            </div>
                            <div class="incident-time">${timestamp}</div>
                            ${topRootCause ? `
                                <div class="root-cause">
                                    üéØ ${topRootCause.service}: ${topRootCause.description}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            selectIncident(incidentId, event) {
                console.log('Selecting incident:', incidentId);
                const incident = this.incidents.find(i => i.incident_id === incidentId);
                if (!incident) {
                    console.error('Incident not found:', incidentId);
                    return;
                }

                this.currentIncident = incident;
                console.log('Current incident:', this.currentIncident);
                this.renderTimeline(incident);
                this.loadCausalGraph(incidentId);

                // Highlight selected incident
                document.querySelectorAll('.incident-item').forEach(item => {
                    item.style.background = '#f7fafc';
                });
                
                // Use the event parameter if provided, otherwise find the element by ID
                const targetElement = event ? 
                    event.target.closest('.incident-item') : 
                    document.querySelector(`.incident-item[data-id="${incidentId}"]`);
                
                if (targetElement) {
                    targetElement.style.background = '#e6fffa';
                }
            }

            renderTimeline(incident) {
                const container = document.getElementById('timelineContainer');
                
                if (!incident.timeline || incident.timeline.length === 0) {
                    container.innerHTML = 
                        '<div style="text-align: center; color: #718096; padding: 2rem;">No timeline data</div>';
                    return;
                }

                const html = incident.timeline.map(event => {
                    const levelClass = event.level.toLowerCase();
                    const marker = event.level === 'ERROR' ? '‚ùå' : 
                                  event.level === 'WARNING' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                    
                    return `
                        <div class="timeline-item">
                            <div class="timeline-marker ${levelClass}">
                                ${event.sequence_id}
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-service">${event.service}</div>
                                <div class="timeline-message">${event.message}</div>
                                <div class="timeline-time">${event.relative_time} (${new Date(event.timestamp).toLocaleTimeString()})</div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            async loadCausalGraph(incidentId) {
                console.log('Loading causal graph for incident:', incidentId);
                try {
                    const response = await fetch(`/api/causal-graph/${incidentId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}: ${await response.text()}`);
                    }
                    const graphData = await response.json();
                    console.log('Loaded causal graph data:', graphData);
                    this.renderCausalGraph(graphData);
                } catch (error) {
                    console.error('Failed to load causal graph:', error);
                    document.getElementById('causalGraph').innerHTML = 
                        `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #e53e3e;">
                            Failed to load causal graph: ${error.message}
                        </div>`;
                }
            }

            renderCausalGraph(graphData) {
                const container = document.getElementById('causalGraph');
                console.log('Rendering causal graph:', graphData);
                
                if (!graphData || !graphData.nodes || graphData.nodes.length === 0) {
                    console.error('No nodes in graph data:', graphData);
                    container.innerHTML = 
                        '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #718096;">No graph data available</div>';
                    return;
                }

                // Create network visualization using Plotly
                const radius = 1;
                const nodeTrace = {
                    x: graphData.nodes.map((_, i) => radius * Math.cos(2 * Math.PI * i / graphData.nodes.length)),
                    y: graphData.nodes.map((_, i) => radius * Math.sin(2 * Math.PI * i / graphData.nodes.length)),
                    mode: 'markers+text',
                    type: 'scatter',
                    text: graphData.nodes.map(n => n.service),
                    textposition: 'top center',
                    textfont: {
                        size: 12,
                        color: '#2d3748'
                    },
                    marker: {
                        size: graphData.nodes.map(n => n.level === 'ERROR' ? 25 : 20),
                        color: graphData.nodes.map(n => n.level === 'ERROR' ? '#e53e3e' : 
                                                   n.level === 'WARNING' ? '#ed8936' : '#4299e1'),
                        line: { width: 2, color: 'white' },
                        symbol: graphData.nodes.map(n => n.level === 'ERROR' ? 'diamond' : 'circle')
                    },
                    hovertemplate: '<b>%{text}</b><br>Level: %{customdata}<br>Message: %{text}<extra></extra>',
                    customdata: graphData.nodes.map(n => n.level),
                    name: 'Events'
                };

                // Create edges
                const edgeTraces = graphData.edges.map(edge => {
                    try {
                        const fromNode = graphData.nodes.find(n => n.id === edge.from);
                        const toNode = graphData.nodes.find(n => n.id === edge.to);
                        
                        if (!fromNode || !toNode) {
                            console.error('Edge references missing node:', edge);
                            return null;
                        }
                        
                        const fromIndex = graphData.nodes.indexOf(fromNode);
                        const toIndex = graphData.nodes.indexOf(toNode);
                        
                        return {
                            x: [
                                Math.cos(2 * Math.PI * fromIndex / graphData.nodes.length),
                                Math.cos(2 * Math.PI * toIndex / graphData.nodes.length),
                                null
                            ],
                            y: [
                                Math.sin(2 * Math.PI * fromIndex / graphData.nodes.length),
                                Math.sin(2 * Math.PI * toIndex / graphData.nodes.length),
                                null
                            ],
                            mode: 'lines',
                            type: 'scatter',
                            line: { 
                                width: 1.5,
                                color: '#cbd5e0',
                                dash: 'dot'
                            },
                            showlegend: false,
                            hovertemplate: 'Causal relationship<extra></extra>'
                        };
                    } catch (error) {
                        console.error('Error creating edge trace:', error, edge);
                        return null;
                    }
                }).filter(Boolean);

                const layout = {
                    title: {
                        text: `Causal Graph - Incident ${graphData.incident_id}`,
                        font: { size: 16 }
                    },
                    showlegend: false,
                    xaxis: {
                        visible: false,
                        range: [-1.5, 1.5]
                    },
                    yaxis: {
                        visible: false,
                        range: [-1.5, 1.5]
                    },
                    margin: { t: 50, l: 20, r: 20, b: 20 },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI, sans-serif' },
                    width: container.clientWidth,
                    height: container.clientHeight,
                    autosize: true
                };

                try {
                    console.log('Plotting graph with nodes:', nodeTrace);
                    console.log('Edge traces:', edgeTraces);
                    Plotly.newPlot('causalGraph', [nodeTrace, ...edgeTraces], layout, 
                        { responsive: true, displayModeBar: false });
                } catch (error) {
                    console.error('Error plotting causal graph:', error);
                    container.innerHTML = 
                        '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #e53e3e;">Error rendering causal graph</div>';
                }
            }

            async analyzeNewIncident() {
                // Generate sample incident for demonstration
                const sampleEvents = [
                    {
                        timestamp: new Date().toISOString(),
                        service: "payment-service",
                        level: "ERROR",
                        message: "Payment processing timeout",
                        metadata: {"timeout_ms": 30000}
                    },
                    {
                        timestamp: new Date(Date.now() + 30000).toISOString(),
                        service: "api-gateway",
                        level: "WARNING", 
                        message: "Increased error rate detected",
                        metadata: {"error_rate": "15%"}
                    },
                    {
                        timestamp: new Date(Date.now() + 60000).toISOString(),
                        service: "user-service",
                        level: "ERROR",
                        message: "Failed to process user request",
                        metadata: {"error_code": "PAYMENT_UNAVAILABLE"}
                    }
                ];

                try {
                    const response = await fetch('/api/analyze-incident', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sampleEvents)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('New incident analyzed:', result);
                        // Reload incidents to show the new one
                        setTimeout(() => this.loadIncidents(), 1000);
                    }
                } catch (error) {
                    console.error('Failed to analyze incident:', error);
                }
            }

            handleIncidentUpdate(incidentData) {
                console.log('Real-time incident update received:', incidentData);
                // Add to incidents list if not already present
                if (!this.incidents.find(i => i.incident_id === incidentData.incident_id)) {
                    this.incidents.unshift(incidentData);
                    this.renderIncidents();
                }
            }

            handleMetricsUpdate(metricsData) {
                console.log('Real-time metrics update received');
                const cacheKey = 'metrics-' + new Date().getTime();
                this.metricsCache.set(cacheKey, metricsData);
                
                // Clean old cache entries
                while (this.metricsCache.size > 100) {
                    const oldestKey = Array.from(this.metricsCache.keys())[0];
                    this.metricsCache.delete(oldestKey);
                }
                
                // Update charts if we're on the metrics tab
                const metricsTab = document.getElementById('metrics-tab');
                if (metricsTab.classList.contains('active')) {
                    this.updateMetricsCharts(metricsData);
                }
            }

            refreshIncidents() {
                this.loadIncidents();
            }
        }

        // Initialize the application
        window.app = new RootCauseAnalysisApp();

        // Global functions for button clicks
        window.analyzeNewIncident = function() {
            if (window.app) {
                window.app.analyzeNewIncident();
            }
        };

        window.refreshIncidents = function() {
            if (window.app) {
                window.app.refreshIncidents();
            }
        };

        window.switchTab = function(tabId) {
            console.log('Switching to tab:', tabId);
            
            // Clear any existing intervals
            if (window.app && window.app.metricsInterval) {
                clearInterval(window.app.metricsInterval);
                window.app.metricsInterval = null;
            }

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Deactivate all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(`${tabId}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Activate selected tab button
            const selectedBtn = document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }

            // Load tab-specific data
            if (tabId === 'metrics' && window.app) {
                window.app.loadMetrics();
            } else if (tabId === 'alerts' && window.app) {
                window.app.loadAlerts();
            }
        }

        function saveSettings() {
            const settings = {
                thresholds: {
                    cpu: {
                        warning: parseInt(document.getElementById('cpuWarningThreshold').value),
                        critical: parseInt(document.getElementById('cpuWarningThreshold').value) + 15
                    },
                    memory: {
                        warning: parseInt(document.getElementById('memoryWarningThreshold').value),
                        critical: parseInt(document.getElementById('memoryWarningThreshold').value) + 15
                    },
                    disk: {
                        warning: parseInt(document.getElementById('diskWarningThreshold').value),
                        critical: parseInt(document.getElementById('diskWarningThreshold').value) + 10
                    }
                },
                theme: document.getElementById('themeSelect').value,
                refreshInterval: parseInt(document.getElementById('refreshInterval').value)
            };

            localStorage.setItem('dashboardSettings', JSON.stringify(settings));
            alert('Settings saved successfully!');
        }

        // Add these methods to the RootCauseAnalysisApp class
        Object.assign(RootCauseAnalysisApp.prototype, {
            async loadMetrics() {
                try {
                    // Clear any existing error messages
                    const charts = ['cpuChart', 'memoryChart', 'diskChart', 'networkChart'];
                    charts.forEach(chartId => {
                        const chart = document.getElementById(chartId);
                        if (chart.innerHTML.includes('Failed to load metrics')) {
                            chart.innerHTML = '';
                        }
                    });

                    const response = await fetch('/api/metrics');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const metrics = await response.json();
                    this.updateMetricsCharts(metrics);

                    // Start periodic updates if not already running
                    if (!this.metricsInterval) {
                        this.metricsInterval = setInterval(() => {
                            const metricsTab = document.getElementById('metrics-tab');
                            if (metricsTab.classList.contains('active')) {
                                this.loadMetrics().catch(console.error);
                            }
                        }, METRICS_CONFIG.updateInterval);
                    }
                } catch (error) {
                    console.error('Failed to load metrics:', error);
                    const errorMessage = '<div style="text-align: center; color: #e53e3e; padding: 2rem;">Failed to load metrics</div>';
                    ['cpuChart', 'memoryChart', 'diskChart', 'networkChart'].forEach(chartId => {
                        document.getElementById(chartId).innerHTML = errorMessage;
                    });
                }
            },

            updateMetricsCharts(metrics) {
                // CPU Usage Chart
                const cpuData = {
                    x: metrics.timestamps,
                    y: metrics.performance.cpu_utilization,
                    type: 'scatter',
                    name: 'CPU Usage',
                    line: { color: '#4299e1' }
                };

                const cpuLayout = {
                    title: 'CPU Usage (%)',
                    height: 200,
                    margin: { t: 30, r: 20, l: 40, b: 30 }
                };

                Plotly.newPlot('cpuChart', [cpuData], cpuLayout, { responsive: true, displayModeBar: false });

                // Memory Usage Chart
                const memoryData = {
                    x: metrics.timestamps,
                    y: metrics.performance.memory_usage,
                    type: 'scatter',
                    name: 'Memory Usage',
                    line: { color: '#48bb78' }
                };

                const memoryLayout = {
                    title: 'Memory Usage (%)',
                    height: 200,
                    margin: { t: 30, r: 20, l: 40, b: 30 }
                };

                Plotly.newPlot('memoryChart', [memoryData], memoryLayout, { responsive: true, displayModeBar: false });

                // Disk I/O Chart
                const diskData = {
                    x: metrics.timestamps,
                    y: metrics.resources.disk_io.write_bytes,
                    type: 'scatter',
                    name: 'Disk Write',
                    line: { color: '#ed8936' }
                };

                const diskLayout = {
                    title: 'Disk Write (bytes/s)',
                    height: 200,
                    margin: { t: 30, r: 20, l: 40, b: 30 }
                };

                Plotly.newPlot('diskChart', [diskData], diskLayout, { responsive: true, displayModeBar: false });

                // Network Traffic Chart
                const networkData = {
                    x: metrics.timestamps,
                    y: metrics.performance.network.bytes_sent,
                    type: 'scatter',
                    name: 'Network Out',
                    line: { color: '#9f7aea' }
                };

                const networkLayout = {
                    title: 'Network Traffic (bytes/s)',
                    height: 200,
                    margin: { t: 30, r: 20, l: 40, b: 30 }
                };

                Plotly.newPlot('networkChart', [networkData], networkLayout, { responsive: true, displayModeBar: false });
            },

            async loadAlerts() {
                try {
                    const response = await fetch('/api/alerts');
                    const alerts = await response.json();
                    this.renderAlerts(alerts);
                } catch (error) {
                    console.error('Failed to load alerts:', error);
                    document.getElementById('alertsList').innerHTML = 
                        '<div style="text-align: center; color: #e53e3e; padding: 2rem;">Failed to load alerts</div>';
                }
            },

            renderAlerts(alerts) {
                const container = document.getElementById('alertsList');
                
                if (!alerts || alerts.length === 0) {
                    container.innerHTML = 
                        '<div style="text-align: center; color: #718096; padding: 2rem;">No alerts found</div>';
                    return;
                }

                const html = alerts.map(alert => {
                    const icon = alert.level === 'ERROR' ? '‚ùå' : 
                               alert.level === 'WARNING' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                    
                    return `
                        <div class="alert-item ${alert.level.toLowerCase()}">
                            <div class="alert-icon">${icon}</div>
                            <div class="alert-content">
                                <div class="alert-service">${alert.service}</div>
                                <div class="alert-message">${alert.message}</div>
                                <div class="alert-time">${new Date(alert.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }
        });

        // Load saved settings on startup
        const savedSettings = localStorage.getItem('dashboardSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            document.getElementById('cpuWarningThreshold').value = settings.thresholds.cpu.warning;
            document.getElementById('memoryWarningThreshold').value = settings.thresholds.memory.warning;
            document.getElementById('diskWarningThreshold').value = settings.thresholds.disk.warning;
            document.getElementById('themeSelect').value = settings.theme;
            document.getElementById('refreshInterval').value = settings.refreshInterval;
        }
    </script>
</body>
</html>
