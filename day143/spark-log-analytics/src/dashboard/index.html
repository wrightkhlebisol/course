<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spark Log Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        
        .header h1 {
            color: #0f172a;
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-running { background: #14b8a6; color: white; }
        .status-stopped { background: #ef4444; color: white; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
            border-color: #cbd5e1;
        }
        
        .card-title {
            font-size: 13px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .card-value {
            font-size: 36px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }
        
        .card-subtitle {
            font-size: 14px;
            color: #94a3b8;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        
        .job-list {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        
        .job-item {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .job-item:last-child {
            border-bottom: none;
        }
        
        .job-success { color: #14b8a6; font-weight: 600; }
        .job-failed { color: #ef4444; font-weight: 600; }
        
        .button {
            background: #14b8a6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .button:hover {
            background: #0d9488;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(20, 184, 166, 0.3);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .metric-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .connection-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .connection-connected { background: #14b8a6; color: white; }
        .connection-disconnected { background: #ef4444; color: white; }
        .connection-connecting { background: #f59e0b; color: white; }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Get API base URL dynamically
        const getApiBaseUrl = () => {
            // If served from the API server, use relative URLs
            if (window.location.origin.includes('localhost:8000') || window.location.origin.includes('127.0.0.1:8000')) {
                return window.location.origin;
            }
            // Otherwise, default to localhost:8000
            return 'http://localhost:8000';
        };
        
        const API_BASE_URL = getApiBaseUrl();
        
        function Dashboard() {
            const [clusterInfo, setClusterInfo] = useState(null);
            const [jobs, setJobs] = useState([]);
            const [analyzing, setAnalyzing] = useState(false);
            const [lastAnalysis, setLastAnalysis] = useState(null);
            const [connectionStatus, setConnectionStatus] = useState('connecting');
            const [error, setError] = useState(null);
            const wsRef = useRef(null);
            
            useEffect(() => {
                // Test API connection
                testConnection();
                
                // Fetch initial data
                fetchClusterInfo();
                fetchJobs();
                
                // Setup WebSocket for real-time updates
                setupWebSocket();
                
                // Setup polling as fallback
                const interval = setInterval(() => {
                    fetchClusterInfo();
                    fetchJobs();
                }, 5000);
                
                return () => {
                    clearInterval(interval);
                    if (wsRef.current) {
                        wsRef.current.close();
                    }
                };
            }, []);
            
            const testConnection = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/health`);
                    if (response.ok) {
                        setConnectionStatus('connected');
                        setError(null);
                    } else {
                        setConnectionStatus('disconnected');
                        setError('API server returned an error');
                    }
                } catch (error) {
                    setConnectionStatus('disconnected');
                    setError(`Cannot connect to API server at ${API_BASE_URL}. Make sure the server is running.`);
                }
            };
            
            const setupWebSocket = () => {
                try {
                    const wsUrl = API_BASE_URL.replace('http://', 'ws://').replace('https://', 'wss://') + '/ws';
                    const ws = new WebSocket(wsUrl);
                    
                    ws.onopen = () => {
                        console.log('WebSocket connected');
                        setConnectionStatus('connected');
                    };
                    
                    ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        if (message.type === 'status_update') {
                            setClusterInfo(message.data);
                        } else if (message.type === 'analysis_complete') {
                            setLastAnalysis(message.data);
                            fetchJobs();
                        }
                    };
                    
                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        setConnectionStatus('disconnected');
                    };
                    
                    ws.onclose = () => {
                        console.log('WebSocket disconnected');
                        // Try to reconnect after 5 seconds
                        setTimeout(setupWebSocket, 5000);
                    };
                    
                    wsRef.current = ws;
                } catch (error) {
                    console.error('Failed to setup WebSocket:', error);
                }
            };
            
            const fetchClusterInfo = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/cluster/info`);
                    if (!response.ok) throw new Error('Failed to fetch cluster info');
                    const data = await response.json();
                    setClusterInfo(data);
                    setConnectionStatus('connected');
                    setError(null);
                } catch (error) {
                    console.error('Failed to fetch cluster info:', error);
                    setConnectionStatus('disconnected');
                    if (!error.message.includes('fetch')) {
                        setError('Failed to fetch cluster information');
                    }
                }
            };
            
            const fetchJobs = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/jobs/history?limit=5`);
                    if (!response.ok) throw new Error('Failed to fetch jobs');
                    const data = await response.json();
                    setJobs(data.jobs);
                    
                    if (data.jobs.length > 0) {
                        // Use details from the job if available, otherwise use the job itself
                        const job = data.jobs[0];
                        // Prefer details object which has the full analysis summary
                        if (job.details) {
                            setLastAnalysis(job.details);
                        } else {
                            // Fallback: create summary from job data
                            setLastAnalysis({
                                total_records_processed: job.records_processed || 0,
                                records_per_second: job.records_processed && job.duration_seconds 
                                    ? Math.round(job.records_processed / job.duration_seconds) 
                                    : 0,
                                duration_seconds: job.duration_seconds || 0,
                                anomaly_count: job.details?.anomaly_count || 0,
                                correlation: job.details?.correlation || null
                            });
                        }
                    }
                } catch (error) {
                    console.error('Failed to fetch jobs:', error);
                }
            };
            
            const runAnalysis = async () => {
                setAnalyzing(true);
                setError(null);
                try {
                    const response = await fetch(`${API_BASE_URL}/analyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            input_path: 'data/input/*.json',
                            output_path: 'data/output'
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Analysis failed');
                    }
                    
                    const data = await response.json();
                    if (data.summary) {
                        setLastAnalysis(data.summary);
                    }
                    // Refresh jobs to get updated history
                    fetchJobs();
                } catch (error) {
                    console.error('Analysis failed:', error);
                    setError(`Analysis failed: ${error.message}`);
                } finally {
                    setAnalyzing(false);
                }
            };
            
            return (
                <div className="container">
                    <div className="header">
                        <h1>‚ö° Spark Log Analytics</h1>
                        <span className={`status-badge ${clusterInfo?.status === 'running' ? 'status-running' : 'status-stopped'}`}>
                            {clusterInfo?.status === 'running' ? '‚óè Running' : '‚óè Stopped'}
                        </span>
                        <span className={`connection-status connection-${connectionStatus}`}>
                            {connectionStatus === 'connected' ? '‚óè Connected' : 
                             connectionStatus === 'connecting' ? '‚óè Connecting...' : '‚óè Disconnected'}
                        </span>
                        {clusterInfo?.ui_web_url && (
                            <a href={clusterInfo.ui_web_url} target="_blank" style={{marginLeft: '10px', color: '#14b8a6', textDecoration: 'none', fontWeight: '600'}}>
                                Spark UI ‚Üí
                            </a>
                        )}
                        <div style={{marginTop: '10px', fontSize: '12px', color: '#64748b'}}>
                            API: {API_BASE_URL}
                        </div>
                    </div>
                    
                    {error && (
                        <div className="error-message">
                            ‚ö†Ô∏è {error}
                        </div>
                    )}
                    
                    <div className="grid">
                        <div className="card">
                            <div className="metric-icon">üéØ</div>
                            <div className="card-title">Application</div>
                            <div className="card-value" style={{fontSize: '20px'}}>
                                {clusterInfo?.app_name || 'N/A'}
                            </div>
                            <div className="card-subtitle">{clusterInfo?.app_id || 'Not started'}</div>
                        </div>
                        
                        <div className="card">
                            <div className="metric-icon">‚öôÔ∏è</div>
                            <div className="card-title">Parallelism</div>
                            <div className="card-value">{clusterInfo?.default_parallelism || 0}</div>
                            <div className="card-subtitle">Concurrent tasks</div>
                        </div>
                        
                        <div className="card">
                            <div className="metric-icon">üìä</div>
                            <div className="card-title">Records Processed</div>
                            <div className="card-value">
                                {lastAnalysis?.total_records_processed?.toLocaleString() || '0'}
                            </div>
                            <div className="card-subtitle">Last analysis</div>
                        </div>
                        
                        <div className="card">
                            <div className="metric-icon">‚ö°</div>
                            <div className="card-title">Throughput</div>
                            <div className="card-value">
                                {lastAnalysis?.records_per_second?.toLocaleString() || '0'}
                            </div>
                            <div className="card-subtitle">Records/second</div>
                        </div>
                    </div>
                    
                    <div className="chart-container">
                        <h2 style={{marginBottom: '20px', color: '#0f172a', fontWeight: '700'}}>Analysis Control</h2>
                        <button 
                            className="button" 
                            onClick={runAnalysis} 
                            disabled={analyzing || clusterInfo?.status !== 'running' || connectionStatus !== 'connected'}
                        >
                            {analyzing ? 'üîÑ Analyzing...' : '‚ñ∂Ô∏è Run Analysis'}
                        </button>
                        {connectionStatus !== 'connected' && (
                            <p style={{marginTop: '10px', color: '#9ca3af', fontSize: '14px'}}>
                                Connect to API server to run analysis
                            </p>
                        )}
                        
                        {lastAnalysis && (
                            <div style={{marginTop: '20px', padding: '16px', background: '#f1f5f9', borderRadius: '8px', border: '1px solid #e2e8f0'}}>
                                <h3 style={{marginBottom: '12px', color: '#0f172a', fontWeight: '600'}}>Last Analysis Results</h3>
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px'}}>
                                    <div>
                                        <div style={{fontSize: '12px', color: '#6b7280'}}>Duration</div>
                                        <div style={{fontSize: '18px', fontWeight: '600'}}>
                                            {lastAnalysis.duration_seconds}s
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{fontSize: '12px', color: '#6b7280'}}>Anomalies</div>
                                        <div style={{fontSize: '18px', fontWeight: '600'}}>
                                            {lastAnalysis.anomaly_count}
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{fontSize: '12px', color: '#6b7280'}}>Correlation</div>
                                        <div style={{fontSize: '18px', fontWeight: '600'}}>
                                            {lastAnalysis.correlation?.correlation_coefficient}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="job-list">
                        <h2 style={{marginBottom: '20px', color: '#0f172a', fontWeight: '700'}}>Recent Jobs</h2>
                        {jobs.length === 0 ? (
                            <p style={{color: '#9ca3af'}}>No jobs executed yet</p>
                        ) : (
                            jobs.map((job, index) => (
                                <div key={index} className="job-item">
                                    <div>
                                        <div style={{fontWeight: '600', marginBottom: '4px'}}>
                                            {job.job_name}
                                        </div>
                                        <div style={{fontSize: '14px', color: '#6b7280'}}>
                                            {new Date(job.timestamp).toLocaleString()}
                                        </div>
                                    </div>
                                    <div style={{textAlign: 'right'}}>
                                        <div className={job.status === 'success' ? 'job-success' : 'job-failed'} 
                                             style={{fontWeight: '600', marginBottom: '4px'}}>
                                            {job.status.toUpperCase()}
                                        </div>
                                        <div style={{fontSize: '14px', color: '#6b7280'}}>
                                            {job.records_processed.toLocaleString()} records in {job.duration_seconds}s
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
