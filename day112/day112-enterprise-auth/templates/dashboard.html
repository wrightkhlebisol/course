{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
        <!-- Welcome Section -->
        <div class="bg-white overflow-hidden shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">{{ user.full_name[0] if user.full_name else user.username[0] }}</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Welcome back</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ user.full_name or user.username }}</dd>
                            <dd class="text-sm text-gray-500">{{ user.department or 'IT Department' }} ‚Ä¢ {{ user.email }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-6">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">üë§</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Groups</dt>
                                <dd class="text-lg font-medium text-gray-900">{{ groups|length }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">üîë</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Access Level</dt>
                                <dd class="text-lg font-medium text-gray-900">
                                    {% set roles = groups|map(attribute='role')|list|unique %}
                                    {% if 'Admin' in roles %}Admin{% elif 'Analyst' in roles %}Analyst{% else %}Viewer{% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">üìä</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Last Login</dt>
                                <dd class="text-lg font-medium text-gray-900" id="lastLogin">Loading...</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">üåê</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">LDAP Status</dt>
                                <dd class="text-lg font-medium text-gray-900" id="ldapStatus">Checking...</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
            <!-- Group Memberships -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Group Memberships</h3>
                    <div class="space-y-3">
                        {% for group in groups %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                            <div>
                                <div class="text-sm font-medium text-gray-900">{{ group.group_name }}</div>
                                <div class="text-sm text-gray-500">Role: {{ group.role }}</div>
                            </div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if group.role == 'Admin' %}bg-red-100 text-red-800{% elif group.role == 'Analyst' %}bg-yellow-100 text-yellow-800{% else %}bg-green-100 text-green-800{% endif %}">
                                {{ group.role }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Activity</h3>
                    <div class="space-y-3">
                        {% for log in recent_logs %}
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-md">
                            <div class="flex-shrink-0">
                                {% if log.action == 'login' %}
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                {% elif log.action == 'sync' %}
                                <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                {% else %}
                                <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                                {% endif %}
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="text-sm text-gray-900">{{ log.action.title() }}</div>
                                <div class="text-sm text-gray-500">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Actions -->
        {% if 'Admin' in groups|map(attribute='role')|list %}
        <div class="mt-6">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Admin Actions</h3>
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <button onclick="syncAllUsers()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Sync All Users
                        </button>
                        <button onclick="viewStats()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            View Statistics
                        </button>
                        <button onclick="checkHealth()" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                            Health Check
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Load dashboard data
async function loadDashboardData() {
    try {
        const healthResponse = await axios.get('/api/health');
        document.getElementById('ldapStatus').textContent = 
            healthResponse.data.services.ldap === 'healthy' ? 'Connected' : 'Disconnected';
        
        // Set last login time
        document.getElementById('lastLogin').textContent = new Date().toLocaleDateString();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        document.getElementById('ldapStatus').textContent = 'Error';
    }
}

// Admin functions
async function syncAllUsers() {
    try {
        const token = localStorage.getItem('auth_token');
        const response = await axios.post('/api/sync/all', {}, {
            headers: { Authorization: `Bearer ${token}` }
        });
        alert(`Sync completed: ${response.data.stats.success} successful, ${response.data.stats.failed} failed`);
    } catch (error) {
        alert('Sync failed: ' + (error.response?.data?.detail || 'Unknown error'));
    }
}

async function viewStats() {
    try {
        const token = localStorage.getItem('auth_token');
        const response = await axios.get('/api/admin/stats', {
            headers: { Authorization: `Bearer ${token}` }
        });
        
        const stats = response.data;
        alert(`System Stats:\nTotal Users: ${stats.total_users}\nActive Sessions: ${stats.active_sessions}\n24h Logins: ${stats.logins_24h}`);
    } catch (error) {
        alert('Failed to load stats: ' + (error.response?.data?.detail || 'Unknown error'));
    }
}

async function checkHealth() {
    try {
        const response = await axios.get('/api/health');
        const health = response.data;
        alert(`System Health: ${health.status}\nLDAP: ${health.services.ldap}\nDatabase: ${health.services.database}`);
    } catch (error) {
        alert('Health check failed: ' + error.message);
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
{% endblock %}
